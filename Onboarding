import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { useMutation } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { 
  Leaf, Globe2, Target, TreeDeciduous, ArrowRight, Sparkles,
  Calculator, Trophy, Heart
} from 'lucide-react';

import VirtualPlanet from '../components/planet/VirtualPlanet';

const steps = [
  {
    id: 'welcome',
    title: 'Welcome to EcoTracker',
    subtitle: 'Your journey to a greener future starts here',
    description: 'Turn everyday actions into meaningful environmental impact through gamification and community.',
  },
  {
    id: 'planet',
    title: 'Your Living Planet',
    subtitle: 'Watch it flourish with your choices',
    description: 'Complete challenges and make eco-friendly choices to grow your virtual planet. Plant trees, unlock animals, and create your own thriving ecosystem.',
  },
  {
    id: 'footprint',
    title: 'Know Your Impact',
    subtitle: 'Science-based carbon calculations',
    description: 'Calculate your personal carbon footprint across housing, transport, and lifestyle. Get personalized insights and actionable recommendations.',
  },
  {
    id: 'challenges',
    title: 'Daily Challenges',
    subtitle: 'Small actions, big impact',
    description: 'Complete daily and weekly challenges to earn eco-points. Build streaks, compete with friends, and climb the global leaderboard.',
  },
  {
    id: 'profile',
    title: 'Set Up Your Profile',
    subtitle: 'Let\'s personalize your experience',
    description: 'Create your identity in the EcoTracker community.',
  }
];

export default function Onboarding() {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [currentStep, setCurrentStep] = useState(0);
  const [username, setUsername] = useState('');
  const [planetAnimation, setPlanetAnimation] = useState(30);

  useEffect(() => {
    const loadUser = async () => {
      const userData = await base44.auth.me();
      setUser(userData);
      setUsername(userData?.full_name?.split(' ')[0] || '');
    };
    loadUser();
  }, []);

  useEffect(() => {
    if (currentStep === 1) {
      // Animate planet growth
      const interval = setInterval(() => {
        setPlanetAnimation(prev => {
          if (prev >= 80) {
            clearInterval(interval);
            return 80;
          }
          return prev + 5;
        });
      }, 500);
      return () => clearInterval(interval);
    }
  }, [currentStep]);

  const createProfileMutation = useMutation({
    mutationFn: async () => {
      await base44.entities.UserProfile.create({
        username: username || user?.full_name || 'Eco Warrior',
        eco_points: 100, // Welcome bonus
        current_streak: 0,
        longest_streak: 0,
        planet_level: 1,
        trees_planted: 1,
        animals_unlocked: ['bird'],
        total_co2_saved: 0,
        last_active_date: new Date().toISOString().split('T')[0]
      });
    },
    onSuccess: () => {
      navigate(createPageUrl('Home'));
    }
  });

  const handleNext = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1);
    } else {
      createProfileMutation.mutate();
    }
  };

  const handleSkip = () => {
    createProfileMutation.mutate();
  };

  const step = steps[currentStep];

  const renderStepContent = () => {
    switch (step.id) {
      case 'welcome':
        return (
          <motion.div
            className="flex flex-col items-center"
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
          >
            <motion.div 
              className="w-32 h-32 rounded-3xl bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center mb-8 shadow-2xl shadow-emerald-300/50"
              animate={{ rotate: [0, 5, 0, -5, 0] }}
              transition={{ duration: 4, repeat: Infinity }}
            >
              <Leaf className="w-16 h-16 text-white" />
            </motion.div>
            <div className="flex gap-3 flex-wrap justify-center">
              {[Globe2, Calculator, Target, Trophy].map((Icon, i) => (
                <motion.div
                  key={i}
                  className="w-14 h-14 rounded-2xl bg-white shadow-lg flex items-center justify-center"
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.5 + i * 0.1 }}
                >
                  <Icon className="w-6 h-6 text-gray-600" />
                </motion.div>
              ))}
            </div>
          </motion.div>
        );

      case 'planet':
        return (
          <VirtualPlanet 
            planetHealth={planetAnimation}
            trees={planetAnimation > 50 ? 3 : 1}
            animals={planetAnimation > 60 ? ['bird'] : []}
            ecoPoints={100}
            showDetails={false}
            size="medium"
          />
        );

      case 'footprint':
        return (
          <motion.div
            className="grid grid-cols-3 gap-4 w-full max-w-sm"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
          >
            {[
              { icon: 'ðŸ ', label: 'Housing', value: '2.5t' },
              { icon: 'ðŸš—', label: 'Transport', value: '3.2t' },
              { icon: 'ðŸ›’', label: 'Lifestyle', value: '1.8t' }
            ].map((item, i) => (
              <motion.div
                key={i}
                className="bg-white rounded-2xl p-4 text-center shadow-lg"
                initial={{ y: 20, opacity: 0 }}
                animate={{ y: 0, opacity: 1 }}
                transition={{ delay: 0.2 + i * 0.1 }}
              >
                <div className="text-3xl mb-2">{item.icon}</div>
                <div className="text-xs text-gray-500">{item.label}</div>
                <div className="text-lg font-bold text-emerald-600">{item.value}</div>
              </motion.div>
            ))}
          </motion.div>
        );

      case 'challenges':
        return (
          <motion.div
            className="space-y-3 w-full max-w-sm"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
          >
            {[
              { icon: 'ðŸš¶', title: 'Walk 6,000 Steps', points: 30 },
              { icon: 'ðŸ¥—', title: 'Eat Plant-Based', points: 25 },
              { icon: 'ðŸšŒ', title: 'Use Public Transit', points: 40 }
            ].map((challenge, i) => (
              <motion.div
                key={i}
                className="flex items-center gap-4 bg-white rounded-2xl p-4 shadow-lg"
                initial={{ x: -20, opacity: 0 }}
                animate={{ x: 0, opacity: 1 }}
                transition={{ delay: 0.2 + i * 0.1 }}
              >
                <div className="text-2xl">{challenge.icon}</div>
                <div className="flex-1">
                  <div className="font-semibold text-gray-900">{challenge.title}</div>
                  <div className="text-xs text-emerald-600">+{challenge.points} pts</div>
                </div>
                <motion.div 
                  className="w-8 h-8 rounded-full bg-emerald-100"
                  animate={{ scale: [1, 1.2, 1] }}
                  transition={{ delay: 0.5 + i * 0.2, duration: 0.5 }}
                />
              </motion.div>
            ))}
          </motion.div>
        );

      case 'profile':
        return (
          <motion.div
            className="w-full max-w-sm space-y-6"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
          >
            <div className="flex flex-col items-center">
              <motion.div 
                className="w-20 h-20 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white text-3xl font-bold mb-4 shadow-lg"
                animate={{ rotate: [0, 10, 0, -10, 0] }}
                transition={{ duration: 2, repeat: Infinity }}
              >
                {username.charAt(0).toUpperCase() || '?'}
              </motion.div>
              <Input
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="Enter your name"
                className="text-center text-lg font-semibold"
              />
              <p className="text-xs text-gray-400 mt-2">This is how you'll appear on the leaderboard</p>
            </div>
            
            <div className="bg-gradient-to-r from-emerald-100 to-teal-100 rounded-2xl p-4 text-center">
              <Sparkles className="w-6 h-6 text-emerald-600 mx-auto mb-2" />
              <p className="text-sm font-semibold text-emerald-700">Welcome Bonus!</p>
              <p className="text-2xl font-black text-emerald-600">+100 Eco Points</p>
            </div>
          </motion.div>
        );

      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-emerald-50 via-white to-teal-50 flex flex-col">
      {/* Progress */}
      <div className="px-6 pt-6">
        <div className="flex gap-2 max-w-xs mx-auto">
          {steps.map((_, i) => (
            <div
              key={i}
              className={`flex-1 h-1.5 rounded-full transition-all ${
                i <= currentStep ? 'bg-emerald-500' : 'bg-gray-200'
              }`}
            />
          ))}
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 flex flex-col items-center justify-center px-6 py-8">
        <AnimatePresence mode="wait">
          <motion.div
            key={step.id}
            initial={{ opacity: 0, x: 50 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: -50 }}
            className="w-full max-w-md flex flex-col items-center"
          >
            {/* Visual */}
            <div className="mb-8">
              {renderStepContent()}
            </div>

            {/* Text */}
            <div className="text-center mb-8">
              <h1 className="text-2xl font-black text-gray-900 mb-2">{step.title}</h1>
              <p className="text-emerald-600 font-medium mb-3">{step.subtitle}</p>
              <p className="text-gray-500 text-sm">{step.description}</p>
            </div>
          </motion.div>
        </AnimatePresence>
      </div>

      {/* Actions */}
      <div className="px-6 pb-8 safe-area-inset-bottom">
        <div className="max-w-md mx-auto space-y-3">
          <Button
            onClick={handleNext}
            disabled={createProfileMutation.isPending}
            className="w-full h-14 text-lg bg-emerald-600 hover:bg-emerald-700 rounded-2xl gap-2"
          >
            {currentStep === steps.length - 1 ? (
              createProfileMutation.isPending ? 'Creating...' : 'Start Your Journey'
            ) : (
              <>
                Continue
                <ArrowRight className="w-5 h-5" />
              </>
            )}
          </Button>
          
          {currentStep < steps.length - 1 && (
            <Button
              variant="ghost"
              onClick={handleSkip}
              className="w-full text-gray-400"
            >
              Skip for now
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}
